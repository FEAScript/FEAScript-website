<!DOCTYPE html>

<!--   ______ ______           _____           _       _     -->
<!--  |  ____|  ____|   /\    / ____|         (_)     | |    -->
<!--  | |__  | |__     /  \  | (___   ___ ____ _ ____ | |_   -->
<!--  |  __| |  __|   / /\ \  \___ \ / __|  __| |  _ \| __|  -->
<!--  | |    | |____ / ____ \ ____) | (__| |  | | |_) | |    -->
<!--  |_|    |______/_/    \_\_____/ \___|_|  |_|  __/| |    -->
<!--                                            | |   | |    -->
<!--                                            |_|   | |_   -->
<!--       Website: https://feascript.com/             \__|  -->

<html>
  <head>
    <title>FEAScript: Solidification Front Propagation in a Two-Dimensional Domain (Multi-threaded)</title>
    <link rel="icon" type="image/x-icon" href="../assets/favicon.ico" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta
      name="description"
      content="This example demonstrates solving an eikonal equation in a two-dimensional domain using the FEAScript library with Web Workers. The problem represents a typical solidification front propagation scenario, where the objective is to track the movement of an interface."
    />
    <meta
      name="keywords"
      content="finite elements, fem, galerkin, computational mechanics, javascript, eikonal, front propagation, web workers"
    />
    <meta name="viewport" content="width=device-width" />
    <!-- Link to the CSS files -->
    <link href="../FEAScript-website.css" rel="stylesheet" type="text/css" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
    <!-- Import the Math.js library for mathematical operations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.12.0/math.min.js"></script>
    <!-- Import the Plotly.js library for plotting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.35.3/plotly.min.js"></script>
    <!-- Import MathJax for writing equations -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script
      id="MathJax-script"
      async
      src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"
    ></script>
    <!-- Import the run_prettify.js library for JavaScript code coloring *** Deprecated library *** -->
    <script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js"></script>
  </head>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-1JPK0KLEC9"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
      dataLayer.push(arguments);
    }
    gtag("js", new Date());

    gtag("config", "G-1JPK0KLEC9");
  </script>

  <body>
    <h1 class="top">
      <a href="../index.html">
        <img
          src="../assets/FEAScriptLogo.png"
          alt="FEAScript Logo"
          id="responsive-logo"
          style="vertical-align: middle"
        />
      </a>
    </h1>
    <h1>Solidification Front Propagation in a Two-Dimensional Domain (Multi-threaded)</h1>

    <ul id="menu">
      <li><a href="#webworkerimplementation">Web Worker Implementation</a></li>
      <li><a href="#results">Results</a></li>
    </ul>

    <div class="highlight-container">
      <p>
        This page demonstrates solving the solidification front propagation problem using FEAScript in a web
        worker for improved browser responsiveness. For the mathematical formulation and theory, see the
        <a href="https://feascript.com/tutorials/SolidificationFront2D.html">basic tutorial</a>.
      </p>

      <p>
        <strong>⚠️ Important:</strong> Due to security restrictions, this example requires launching the
        browser with reduced security settings, e.g.:
      </p>
      <pre style="background-color: #f8f9fa; padding: 8px; border-radius: 4px; overflow-x: auto">
start chrome --disable-web-security --user-data-dir="C:\tmp\chrome-cors" --disable-site-isolation-trials</pre
      >
      <p>
        These flags temporarily disable CORS restrictions that normally block a web worker from loading
        scripts or data when running from local files. For production applications, proper CORS headers should
        be configured on your server.
      </p>
    </div>

    <h2 id="webworkerimplementation"><a name="Web Worker Implementation"></a>Web Worker Implementation</h2>
    <p>
      The code below shows how to use FEAScript with a web worker to solve the eikonal equation for front
      propagation. This approach moves the computation to a separate thread, preventing the UI from freezing
      during complex calculations. The solution is plotted as a 2D contour.
    </p>

    <pre class="prettyprint">
&lt;body&gt;
  &lt;!-- ...body region... --&gt;
  &lt;script type="module"&gt;
    // Import FEAScript library
    import { FEAScriptWorker, plotSolution, printVersion } from "https://core.feascript.com/src/index.js";
    
    window.addEventListener("DOMContentLoaded", async () =&gt; {
      // Print FEAScript version in the console
      printVersion();
  
      // Create a new FEAScriptWorker instance
      const model = new FEAScriptWorker();
  
      // Ensure the worker is ready
      await model.ping();
  
      // Configure model
      await model.setSolverConfig("frontPropagationScript");
      await model.setMeshConfig({
        meshDimension: "2D",
        elementOrder: "quadratic",
        numElementsX: 12,
        numElementsY: 8,
        maxX: 4,
        maxY: 2,
      });
  
      // Apply boundary conditions
      await model.addBoundaryCondition("0", ["constantValue", 0]); // Bottom
      await model.addBoundaryCondition("1", ["constantValue", 0]); // Left
      await model.addBoundaryCondition("2", ["zeroGradient"]); // Top
      await model.addBoundaryCondition("3", ["constantValue", 0]); // Right
  
      // Solve
      await model.setSolverMethod("lusolve");
      const { solutionVector, nodesCoordinates } = await model.solve();
  
      // Plot results
      plotSolution(
        solutionVector,
        nodesCoordinates,
        "frontPropagationScript",
        "2D",
        "contour",
        "resultsCanvas"
      );
  
      // Terminate the worker
      model.terminate();
    });
  &lt;/script&gt;
  &lt;!-- ...rest of body region... --&gt;
&lt;/body&gt;</pre
    >

    <h2 id="results"><a name="Results"></a>Results</h2>
    <p>
      Below is the 2D contour plot of the computed front propagation. The contour values represent the arrival
      time of the front at each position. This plot is generated in real time using FEAScript.
    </p>

    <div id="orientation-message">
      Cannot draw the results. Please turn your phone to horizontal position and refresh the page to see the
      results.
    </div>
    <div id="loading">
      <div class="spinner"></div>
      Solving...
    </div>
    <div id="resultsCanvas"></div>

    <ul id="menu">
      <li><a href="https://feascript.com/index.html">Home</a></li>
      <li><a href="https://feascript.com/#tutorials">All Tutorials</a></li>
    </ul>

    <script type="module">
      //Import FEAScript library from GitHub
      import { FEAScriptWorker, plotSolution, printVersion } from "https://core.feascript.com/src/index.js";

      // KNOWN BUG: The bundled ESM version has issues with Web Workers due to path resolution problems.
      // Web Workers cannot be properly initialized when importing from the bundled file.
      //import { FEAScriptWorker, plotSolution, printVersion } from "https://core.feascript.com/dist/feascript.esm.js";

      //Import FEAScript library from a local directory
      // import { FEAScriptWorker, plotSolution, printVersion } from "../../FEAScript-core/src/index.js";

      window.addEventListener("DOMContentLoaded", async () => {
        if (window.innerHeight > window.innerWidth) {
          document.getElementById("orientation-message").style.display = "block";
          document.getElementById("resultsCanvas").style.display = "none";
          document.getElementById("loading").style.display = "none";
        } else {
          document.getElementById("orientation-message").style.display = "none";
          document.getElementById("resultsCanvas").style.display = "block";

          // Show loading indicator
          document.getElementById("loading").style.display = "block";

          // Print FEAScript version
          printVersion();

          // Create a new FEAScriptWorker instance
          const model = new FEAScriptWorker();

          try {
            // Ensure the worker is ready
            await model.ping();

            // Set solver configuration
            await model.setSolverConfig("frontPropagationScript");

            // Define mesh configuration
            await model.setMeshConfig({
              meshDimension: "2D",
              elementOrder: "quadratic",
              numElementsX: 12,
              numElementsY: 8,
              maxX: 4,
              maxY: 2,
            });

            // Define boundary conditions
            await model.addBoundaryCondition("0", ["constantValue", 0]); // Bottom
            await model.addBoundaryCondition("1", ["constantValue", 0]); // Left
            await model.addBoundaryCondition("2", ["zeroGradient"]); // Top
            await model.addBoundaryCondition("3", ["constantValue", 0]); // Right

            // Set solver method
            await model.setSolverMethod("lusolve");

            // Solve the problem and get the solution
            const { solutionVector, nodesCoordinates } = await model.solve();

            // Plot the solution as a 2D contour plot
            plotSolution(
              solutionVector,
              nodesCoordinates,
              "frontPropagationScript",
              "2D",
              "contour",
              "resultsCanvas"
            );
          } catch (error) {
            console.error("Error in worker execution:", error);
            alert("Error executing the solver. Check console for details.");
          } finally {
            // Hide loading indicator
            document.getElementById("loading").style.display = "none";

            // Terminate the worker
            model.terminate();
          }
        }
      });

      window.addEventListener("resize", () => {
        if (window.innerHeight > window.innerWidth) {
          document.getElementById("orientation-message").style.display = "block";
          document.getElementById("resultsCanvas").style.display = "none";
        } else {
          document.getElementById("orientation-message").style.display = "none";
          document.getElementById("resultsCanvas").style.display = "block";
        }
      });
    </script>

    <footer>
      <p>&#169; 2023-<span id="currentYear"></span> FEAScript</p>
    </footer>
    <script>
      document.getElementById("currentYear").innerHTML = new Date().getFullYear();
    </script>
  </body>
</html>
