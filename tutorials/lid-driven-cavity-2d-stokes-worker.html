<!DOCTYPE html>

<!--
  ════════════════════════════════════════════════════════════════
   FEAScript Website
   Lightweight Finite Element Simulation in JavaScript
   Version: 0.2.0 | https://feascript.com
   CC BY 4.0 License © 2023–2026 FEAScript
  ════════════════════════════════════════════════════════════════
-->

<html>
  <head>
    <title>FEAScript: Stokes Flow in a 2D Lid-Driven Cavity Tutorial (Multi-threaded)</title>
    <link rel="icon" type="image/x-icon" href="../assets/favicon.ico" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta
      name="description"
      content="This tutorial demonstrates solving the steady Stokes equations in a 2D lid-driven cavity using FEAScript with a web worker. It uses Taylor-Hood (Q2-Q1) mixed finite elements for velocity-pressure coupling."
    />
    <meta
      name="keywords"
      content="finite elements, fem, galerkin, computational mechanics, javascript, stokes flow, lid-driven cavity, web workers, multi-threaded"
    />
    <meta name="viewport" content="width=device-width" />
    <!-- Link to the CSS files -->
    <link href="../feascript-website.css" rel="stylesheet" type="text/css" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
    <!-- Import the Math.js library for mathematical operations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.12.0/math.min.js"></script>
    <!-- Import the Plotly.js library for plotting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.35.3/plotly.min.js"></script>
    <!-- Import MathJax for writing equations -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script
      id="MathJax-script"
      async
      src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"
    ></script>
    <!-- Import the run_prettify.js library for JavaScript code coloring *** Deprecated library *** -->
    <script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js"></script>
  </head>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-1JPK0KLEC9"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
      dataLayer.push(arguments);
    }
    gtag("js", new Date());

    gtag("config", "G-1JPK0KLEC9");
  </script>

  <body>
    <h1 class="top">
      <a href="../index.html">
        <img
          src="../assets/feascript-logo.png"
          alt="FEAScript Logo"
          id="responsive-logo"
          style="vertical-align: middle"
        />
      </a>
      <div class="social-icons-top-right">
        <ul>
          <li>
            <a href="https://blog.feascript.com/" title="FEAScript blog">
              <img
                src="../assets/blog-icon-feascript.png"
                alt="Blog icon"
                style="height: 18px; vertical-align: middle"
              />
            </a>
          </li>
          <li>
            <a href="https://www.youtube.com/@FEAScript" title="FEAScript YouTube">
              <img
                src="../assets/youtube-icon-feascript.svg"
                alt="YouTube icon"
                style="height: 18px; vertical-align: middle"
              />
            </a>
          </li>
          <li>
            <a href="https://www.linkedin.com/company/feascript/" title="FEAScript LinkedIn">
              <img
                src="../assets/linkedin-icon-feascript.png"
                alt="LinkedIn icon"
                style="height: 18px; vertical-align: middle"
              />
            </a>
          </li>
          <li>
            <a href="https://discord.gg/3DVjNcuW4f" title="FEAScript Discord">
              <img
                src="../assets/discord-icon-feascript.png"
                alt="Discord icon"
                style="height: 18px; vertical-align: middle"
              />
            </a>
          </li>
          <li>
            <a href="https://github.com/FEAScript/FEAScript-core" title="FEAScript GitHub">
              <img
                src="../assets/github-icon-feascript.png"
                alt="GitHub icon"
                style="height: 20px; vertical-align: middle"
              />
              <span
                id="github-stars"
                style="
                  font-size: 0.9em;
                  margin-left: 5px;
                  vertical-align: middle;
                  border: 1px solid #ddd;
                  border-radius: 4px;
                  padding: 1px 5px;
                  background-color: #f8f8f8;
                "
              ></span>
            </a>
          </li>
        </ul>
      </div>
    </h1>
    <h1>Stokes Flow in a 2D Lid-Driven Cavity Tutorial (Multi-threaded)</h1>

    <ul id="menu">
      <li><a href="#webworkerimplementation">Web Worker Implementation</a></li>
      <li><a href="#results">Results</a></li>
    </ul>

    <div class="highlight-container">
      <p>
        This page demonstrates solving the 2D lid-driven cavity problem using FEAScript in a web worker for
        improved browser responsiveness. For the mathematical formulation and theory, see the
        <a href="https://feascript.com/tutorials/lid-driven-cavity-2d-stokes.html">basic tutorial</a>.
      </p>

      <p>
        <strong>⚠️ Important:</strong> Due to security restrictions, this example requires launching the
        browser with reduced security settings, e.g.:
      </p>
      <pre style="background-color: #f8f9fa; padding: 8px; border-radius: 4px; overflow-x: auto">
start chrome --disable-web-security --user-data-dir="C:\tmp\chrome-cors" --disable-site-isolation-trials</pre
      >
      <p>
        These flags temporarily disable CORS restrictions that normally block a web worker from loading
        scripts or data when running from local files. For production applications, proper CORS headers should
        be configured on your server.
      </p>
    </div>

    <h2 id="webworkerimplementation"><a name="Web Worker Implementation"></a>Web Worker Implementation</h2>
    <p>
      The code below shows how to use FEAScript with a web worker. The velocity field is decomposed and plotted as contour plots.
    </p>

    <pre class="prettyprint">
&lt;body&gt;
  &lt;!-- ...body region... --&gt;
  &lt;script type="module"&gt;
    // Import FEAScript library
    import { FEAScriptWorker, plotSolution, printVersion } from "https://core.feascript.com/src/index.js";
    
    window.addEventListener("DOMContentLoaded", async () =&gt; {
      // Print FEAScript version in the console
      printVersion();
  
      // Create a new FEAScriptWorker instance
      const model = new FEAScriptWorker();
  
      // Ensure the worker is ready
      await model.ping();
  
      // Configure model
      await model.setModelConfig("stokesScript");
      // Mesh parameters
      const numElementsX = 12;
      const numElementsY = 6;
      await model.setMeshConfig({
        meshDimension: "2D",
        elementOrder: "quadratic",
        numElementsX: numElementsX,
        numElementsY: numElementsY,
        maxX: 4,
        maxY: 2,
      });
  
      // Apply boundary conditions
      await model.addBoundaryCondition("0", ["constantVelocity", 0, 0]); // Bottom boundary
      await model.addBoundaryCondition("1", ["constantVelocity", 0, 0]); // Left boundary
      await model.addBoundaryCondition("2", ["constantVelocity", 1, 0]); // Top boundary
      await model.addBoundaryCondition("3", ["constantVelocity", 0, 0]); // Right boundary
  
      // Solve
      await model.setSolverMethod("lusolve");
      const result = await model.solve();
  
      // Calculate total velocity nodes for quadratic elements
      const nodesX = 2 * numElementsX + 1;
      const nodesY = 2 * numElementsY + 1;
      const totalNodesVelocity = nodesX * nodesY;

      // Extract solution components
      const solutionVector = result.solutionVector;
      const uVelocity = solutionVector.slice(0, totalNodesVelocity);
      const vVelocity = solutionVector.slice(totalNodesVelocity, 2 * totalNodesVelocity);
      const velocityMagnitude = uVelocity.map((u, i) => Math.sqrt(u * u + vVelocity[i] * vVelocity[i]));

      // Get model info for plotting
      const modelInfo = await model.getModelInfo();

      // Plot results
      plotSolution(modelInfo, { solutionVector: velocityMagnitude, nodesCoordinates: result.nodesCoordinates },
        "contour", "velocityMagnitudeCanvas");
      plotSolution(modelInfo, { solutionVector: uVelocity, nodesCoordinates: result.nodesCoordinates },
        "contour", "uVelocityCanvas");
      plotSolution(modelInfo, { solutionVector: vVelocity, nodesCoordinates: result.nodesCoordinates },
        "contour", "vVelocityCanvas");
  
      // Terminate the worker
      model.terminate();
    });
  &lt;/script&gt;
  &lt;!-- ...rest of body region... --&gt;
&lt;/body&gt;</pre
    >

    <h2 id="results"><a name="Results"></a>Results</h2>
    <p>
      Below are the 2D contour plots of the computed velocity magnitude \(|\mathbf{u}| = \sqrt{u^2+v^2}\),
      horizontal velocity component \(u\), and vertical velocity component \(v\). These plots are
      generated in real time using FEAScript.
    </p>

    <div id="loading">
      <div class="spinner"></div>
      Solving...
    </div>

    <h3>Velocity Magnitude</h3>
    <div id="velocityMagnitudeCanvas"></div>

    <h3>Horizontal Velocity (\(u\))</h3>
    <div id="uVelocityCanvas"></div>

    <h3>Vertical Velocity (\(v\))</h3>
    <div id="vVelocityCanvas"></div>

    <ul id="menu">
      <li><a href="https://feascript.com/index.html">Home</a></li>
      <li><a href="https://feascript.com/#tutorials">All Tutorials</a></li>
    </ul>

    <script type="module">
      //Import FEAScript library from GitHub
      import { FEAScriptWorker, plotSolution, printVersion } from "https://core.feascript.com/src/index.js";

      //Data Layer
      if (typeof window.dataLayer === 'undefined') {
        window.dataLayer = [];
      }
      
      window.addEventListener("DOMContentLoaded", async () => {
        // Show loading indicator
        document.getElementById("loading").style.display = "block";

        // Print FEAScript version
        console.log("FEAScript version:", printVersion);

        // Create a new FEAScriptWorker instance
        const model = new FEAScriptWorker();

        // Ensure the worker is ready
        await model.ping();

        // Set solver configuration
        await model.setModelConfig("stokesScript");

        // Define mesh configuration
        const numElementsX = 12;
        const numElementsY = 6;
        await model.setMeshConfig({
          meshDimension: "2D",
          elementOrder: "quadratic",
          numElementsX: numElementsX,
          numElementsY: numElementsY,
          maxX: 4,
          maxY: 2,
        });

        // Define boundary conditions
        await model.addBoundaryCondition("0", ["constantVelocity", 0, 0]);
        await model.addBoundaryCondition("1", ["constantVelocity", 0, 0]);
        await model.addBoundaryCondition("2", ["constantVelocity", 1, 0]);
        await model.addBoundaryCondition("3", ["constantVelocity", 0, 0]);

        // Set solver method
        await model.setSolverMethod("lusolve");

        // Solve the problem and get the solution
        const result = await model.solve();

        // Calculate totalNodesVelocity manually as it is not exposed by worker getModelInfo
        const nodesX = 2 * numElementsX + 1;
        const nodesY = 2 * numElementsY + 1;
        const totalNodesVelocity = nodesX * nodesY;

        // Extract velocity and pressure fields from the solution vector
        const solutionVector = result.solutionVector;
        const uVelocity = solutionVector.slice(0, totalNodesVelocity);
        const vVelocity = solutionVector.slice(totalNodesVelocity, 2 * totalNodesVelocity);
        const velocityMagnitude = uVelocity.map((u, i) => Math.sqrt(u * u + vVelocity[i] * vVelocity[i]));

        // Get model info for plotting
        const modelInfo = await model.getModelInfo();

        // Hide loading indicator
        document.getElementById("loading").style.display = "none";

        // Plot results
        plotSolution(modelInfo, { solutionVector: velocityMagnitude, nodesCoordinates: result.nodesCoordinates },
          "contour", "velocityMagnitudeCanvas");
        
        plotSolution(modelInfo, { solutionVector: uVelocity, nodesCoordinates: result.nodesCoordinates },
          "contour", "uVelocityCanvas");

        plotSolution(modelInfo, { solutionVector: vVelocity, nodesCoordinates: result.nodesCoordinates },
          "contour", "vVelocityCanvas");

        // Terminate the worker
        model.terminate();
      });
    </script>

    <footer>
      <p>&#169; 2023-<span id="currentYear"></span> FEAScript</p>
    </footer>
    <script>
      document.getElementById("currentYear").innerHTML = new Date().getFullYear();

      // Fetch GitHub stars
      fetch("https://api.github.com/repos/FEAScript/FEAScript-core")
        .then((response) => response.json())
        .then((data) => {
          const starCount = data.stargazers_count;
          const starsElement = document.getElementById("github-stars");
          if (starsElement && starCount) {
            starsElement.innerHTML = `★ ${starCount}`;
          }
        })
        .catch((error) => console.error("Error fetching GitHub stars:", error));
    </script>
  </body>
</html>
